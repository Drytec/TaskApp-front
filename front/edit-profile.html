<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile</title>
  <link rel="stylesheet" href="/src/css/edit-profile.css">
  <link rel="icon" type="image/png" href="/public/favicon.jpeg" />
</head>

<body>
  <div class="edit-container">
    <h2>Edit Profile</h2>
    <form id="editProfileForm">
      <div class="form-group">
        <label for="editFirstName">First Name</label>
        <input type="text" id="editFirstName" required />
      </div>
      <div class="form-group">
        <label for="editLastName">Last Name</label>
        <input type="text" id="editLastName" required />
      </div>
      <div class="form-group">
        <label for="editAge">Age</label>
        <input type="number" id="editAge" min="1" />
      </div>
      <div class="form-group">
        <label for="editEmail">Email</label>
        <input type="email" id="editEmail" required readonly />
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" onclick="cancelEdit()">Cancel</button>
        <button type="submit" class="btn-save">Save Changes</button>
      </div>
    </form>
  </div>

  <div id="feedbackModal" class="modal-overlay">
    <div id="modalContent" class="modal-box">
      <p id="modalMessage"></p>
      <div id="modalButtons" class="modal-actions"></div>
    </div>
  </div>

  <script src="../js/auth.js"></script>
  <script>
    /** @type {Object} Stores the original user data for comparison */
    let originalUser = {};

    /**
     * Load the current user's profile information when the page is ready.
     * Fills input fields with the user's current data and positions the cursor at the end.
     */
    document.addEventListener('DOMContentLoaded', async () => {
      const token = getToken();
      if (!token) {
        window.location.href = '/login';
        return;
      }

      // Fetch current user data
      const res = await fetch(`${API_URL}/users/me`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if(res.ok){
        const user = await res.json();
        originalUser = { 
          name: user.name || '',
          lastname: user.lastname || '',
          age: user.age || '',
          email: user.email || ''
        };

        const firstNameInput = document.getElementById('editFirstName');
        const lastNameInput = document.getElementById('editLastName');
        const ageInput = document.getElementById('editAge');
        const emailInput = document.getElementById('editEmail');

        firstNameInput.value = originalUser.name;
        lastNameInput.value = originalUser.lastname;
        ageInput.value = originalUser.age;
        emailInput.value = originalUser.email;

        // Move cursor to the end for editable inputs
        [firstNameInput, lastNameInput, ageInput].forEach(input => {
          input.addEventListener("focus", () => {
            const length = input.value.length;
            setTimeout(() => { input.setSelectionRange(length, length); }, 0);
          });
        });
      }
    });

    /**
     * Handle form submission for editing the user profile.
     * Validates changes, prevents unnecessary updates, calls `updateUser` from auth.js,
     * and shows success/error feedback in a modal.
     * @param {Event} e - The submit event.
     */
    document.getElementById('editProfileForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      const updatedUser = {
        name: document.getElementById('editFirstName').value.trim(),
        lastname: document.getElementById('editLastName').value.trim(),
        age: document.getElementById('editAge').value.trim()
      };

      // Check if nothing changed
      if (
        updatedUser.name === originalUser.name &&
        updatedUser.lastname === originalUser.lastname &&
        updatedUser.age === String(originalUser.age)
      ) {
        showModal("⚠️ No changes detected.", "warning");
        return;
      }

      try {
        await updateUser(updatedUser); // function from auth.js
        showModal("✅ Profile updated successfully", "success", false, () => {
          window.location.href = "/profile";
        });
      } catch (err) {
        showModal("❌ Error updating profile: " + (err.message || "unknown"), "error");
      }
    });

    /**
     * Cancel editing the profile and navigate back to the profile page.
     */
    function cancelEdit(){
      window.location.href = "/profile";
    }

    /**
     * Display a modal dialog with a message, optional cancel button, and optional callback.
     * @param {string} message - The message to show in the modal.
     * @param {string} [type="success"] - The type of modal: "success", "error", or "warning".
     * @param {boolean} [withCancel=false] - Whether to show a Cancel button.
     * @param {Function} [onConfirm=null] - Callback function to execute when OK is clicked.
     */
    function showModal(message, type="success", withCancel=false, onConfirm=null) {
      const modal=document.getElementById("feedbackModal");
      const msg=document.getElementById("modalMessage");
      const buttons=document.getElementById("modalButtons");

      msg.textContent=message;
      document.getElementById("modalContent").className=`modal-box ${type}`;

      buttons.innerHTML="";
      const ok=document.createElement("button");
      ok.textContent="OK"; ok.className="ok-btn";
      ok.onclick=()=>{ closeModal(); if(onConfirm) onConfirm(); };
      buttons.appendChild(ok);

      if(withCancel){
        const cancel=document.createElement("button");
        cancel.textContent="Cancel"; cancel.className="cancel-btn";
        cancel.onclick=()=>{ closeModal(); };
        buttons.appendChild(cancel);
      }

      modal.style.display="flex";
    }

    /**
     * Close the currently displayed modal.
     */
    function closeModal(){ 
      document.getElementById("feedbackModal").style.display="none"; 
    }
  </script>
</body>

</html>

